function playerView(){function e(e){U.show(),horizons_data=[],horizons_data.push(L(e.d._context_)),q.pHorizonGroup.data(horizons_data),q.pHorizonGroup.update();e.d._context_.metadata}function t(e){k(e.d._context_)}function n(e){E(e.d._context_)}function r(e){console.log("d",e.d),console.log("x",e.extents),console.log("a",e.axis_values),console.log("v",e.item_values),console.log("m",e)}function o(e){var t=0;return e.forEach(function(e){e.data.sources.indexOf("mcp")>=0&&(t+=1)}),t}function i(e){var t=0;return e.forEach(function(e){e.data.sources.indexOf("pbp")>=0&&(t+=1)}),t}function s(e){var t=[];return e.forEach(function(e){var a=e.data.metadata.players[1].name;t.indexOf(a)<0&&t.push(a)}),t}function c(e){var t=[];return e.forEach(function(e){t.indexOf(e.tournament)<0&&t.push(e.tournament)}),t}function l(e){var t=[];$.forEach(function(a){for(var n={},r=0;r<a.matches.length;r++)a.matches[r].data.metadata.players[1].name==e&&(Object.keys(a).forEach(function(e){n[e]=a[e]}),n.matches=[a.matches[r]],t.push(n))}),$=t,Z=$,J=J.filter(function(t){return t.data.metadata.players[1].name==e}),X=J,U.displayLadder($)}function d(e){$=$.filter(function(t){return t.tournament==e}),Z=$,J=J.filter(function(t){return t.data.metadata.tournament.name==e}),X=J,U.displayLadder($)}function u(){var e=q.pCoords.filteredData(),t=e.map(function(e){return e._context_}),a=U.matchSurfaces(t);U.displayCounts(a,"#filteredSurfaces",!1)}function p(){d3.select("#filteredSurfaces").selectAll(".sc").remove()}function m(){U.hide(["horizon_group"]),mv.hide()}function f(){var e=q.pCoords.activeBrushes();e.length?u():p()}function h(e){interact.showModal(e)}function v(){var e=q.pCoords.hide().filter(function(e){return["_context_","Date","surface","muid"].indexOf(e)<0}),t=q.pCoords.activeAxes().concat(e),a="<h2> Parallel Coordinates Settings </h2><p>Select the Dimensions to view in the Parallel Coordinates Chart:  <p>";a+='<div class="flex-modal-parent">',t.forEach(function(t){var n=e.indexOf(t)<0;a+='<div class="flex-modal-check">',a=a+'<input type="checkbox" class="settingsPC" name="'+t+'" value="'+t+'"',n&&(a+="checked"),a=a+">"+t+"</div>"}),a+="</div>",a+='<div class="flex-meta-parent"> <div class="flex-meta-child"> <button class="btn meta-btn meta-submit" alt="Submit" onclick="pv.selectAxes()" tabindex="-1">Submit</button> <button class="btn meta-btn meta-cancel" alt="Cancel" onclick="interact.closeModal()" tabindex="-1">Cancel</button> </div> </div>',interact.showModal(a,"Parallel Coordinates Settings")}function g(e){e=e||Y;var t={};return e.forEach(function(e){var a=e.surface.toLowerCase();Object.keys(t).indexOf(a)<0&&(t[a]={tournaments:0,matches:0,wins:0}),t[a].tournaments+=1,t[a].matches+=e.matches.length,e.matches.forEach(function(e){e.won&&(t[a].wins+=1)})}),t}function y(e){var t={};return e.forEach(function(e){var a=e.metadata.tournament.surface.toLowerCase();Object.keys(t).indexOf(a)<0&&(t[a]={matches:0,wins:0}),t[a].matches+=1,e.won&&(t[a].wins+=1)}),t}function w(e){te=!1,e&&"all"!=e?($=$.filter(function(t){var a=t.surface;return a.toLowerCase()==e.toLowerCase()}),Z=$,J=J.filter(function(t){var a=t.data.metadata.tournament.surface;return a.toLowerCase()==e.toLowerCase()}),X=J,U.displayLadder($),mv.hide()):U.displayLadder(Y)}function x(e){te=!1;var t=e.getFullYear(),a=new Date(t+"-01-01"),n=new Date(+t+1+"-01-01");console.log(a,n),n=n>U.maxDate?U.maxDate:n,q.datePicker.set(a,n)}function _(e){var t=e[0],a=e[1];te=!1,$=Y.filter(function(e){var n=e.date;return n>=t&&a>=n}),Z=$,J=K.filter(function(e){var n=new Date(e.data.metadata.match.date);return n>=t&&a>=n}),X=J,U.displayLadder($)}function b(e){te=!0,O(e);var t=re[e];J=X.filter("W"==t?function(e){return"F"==e.round&&e.won}:"Q"==t?function(e){return e.round.indexOf("Q")>=0}:function(e){return e.round==t});var a=J.map(function(e){return e.data}),n=U.matchSurfaces(a);U.displayCounts(n,"#surfaceFilters"),U.displayStats(J),U.df(),U.hide(["horizon_group"]),d3.select("#tName").text(""),mv.hide()}function C(){te=!1,$=Y,Z=Y,J=K,X=K,q.datePicker.set(new Date,new Date),U.displayLadder()}function O(e){d3.selectAll(".itemDate").style({opacity:function(t){return t.rung==e||void 0==e?.8:.15}}),d3.selectAll(".itemConnector").style({"stroke-opacity":function(){return e?.2:.7},"stroke-width":function(){return e?2:1}})}function k(e){if(!te){var t=q.ladderChart.exports().shapeColor,a=q.ladderChart.exports().root;a.selectAll(".itemDate").style({fill:t,opacity:.7}),a.select("[id='itemDate"+e.tidx+"']").style({fill:"yellow",opacity:.7})}}function E(e){if(!te){var t=q.ladderChart.exports().shapeColor,a=q.ladderChart.exports().root;e.tidx!=N&&a.select("[id='itemDate"+e.tidx+"']").style({fill:t,opacity:.7})}}function P(e){function t(t){e.codesFetched=!0,t.forEach(function(t){for(var a=0;a<e.matches.length;a++)e.matches[a].muid==t.muid&&(e.matches[a].data.codes=t.codes,e.matches[a].reversed&&e.matches[a].data.codes.forEach(function(e){e.first_service=1-e.first_service}))})}function a(){U.updateCharts(e)}N=e.tidx,"function"==typeof ne.clickTournament&&ne.clickTournament(e);var n=e.date.getFullYear();U.displayStats(e.matches),q.pHorizonGroup.data([]).update(),d3.select("#matchDate").text("");var r=d3.select("#tName");if(e&&e.matches){var n=e.date.getFullYear();r.text(e.tournament+" "+n).on("click",function(){console.log(e.tuid)})}else r.text("");e.codesFetched?a():aip.getPlayerTourneyMatches(e.tuid,U.player.puid,n,function(e,n){e||(t(n),a())})}function F(e){e.forEach(function(e){K[V[e.muid]]&&(K[V[e.muid]].data.stats=e.stats)})}function z(e){function t(e){var t={};return e.forEach(function(e){var a=Object.keys(e),n=e[a];t[a]=Array.isArray(n)?n:[n,n]}),t}var a=[];return e.forEach(function(e){if(e.data.stats&&e.data.stats[0].raw&&e.data.stats[0].raw.length){var n=e.data.metadata;statObj={_context_:e.data},statObj.surface=n.tournament.surface;var r=t(e.data.stats[0].raw),o=r.A,i=r.DF,s=r.SP,c=r.S1In,l=r.S1PW,d=r.S2PW;l[0]=l[0]||0,d[0]=d[0]||0,l[1]=l[1]||0,d[1]=d[1]||0;var u=(r.SG,r.bpS),p=r.bpF,m=s.reduce(function(e,t){return+e+ +t}),f=m?((+l[0]+ +d[0]+(s[1]-+l[1]-+d[1]))/m*100).toFixed(1):0,h=+s[1]?((+s[1]-+l[1]-+d[1])/+s[1]*100).toFixed(1):0,v=+s[0]?((+s[0]-+l[0]-+d[0])/+s[0]*100).toFixed(1):0,g=+p[0]?(+u[0]/+p[0]*100).toFixed(1):0,y=+p[1]?((+p[1]-+u[1])/+p[1]*100).toFixed(1):0,w=n.players[0].age&&n.players[1].age?n.players[1].age-n.players[0].age:0,x=+c[0]?(+l[0]/+c[0]*100).toFixed(1):0,_=+s[0]-+c[0]?(+d[0]/(+s[0]-+c[0])*100).toFixed(1):0,b=+c[1]?((+c[1]-+l[1])/+c[1]*100).toFixed(1):0,C=+s[1]-+c[1]?((+s[1]-+c[1]-+d[1])/(+s[1]-+c[1])*100).toFixed(1):0;statObj.Date=new Date(n.match.date),statObj.Won=e.won?1:0,statObj.vRank=n.players[1].rank?n.players[1].rank:0,statObj.aRank=n.players[0].rank?n.players[0].rank:0,statObj.vAge=w,statObj.aAge=n.players[0].age?n.players[0].age:18,statObj.TP=m,statObj.DR=v>0?(h/v).toFixed(1):0,statObj["Ace %"]=+s[0]?(+o[0]/+s[0]*100).toFixed(1):0,statObj["DF %"]=s[0]?(+i[0]/+s[0]*100).toFixed(1):0,statObj["1st In"]=s[0]?(+c[0]/+s[0]*100).toFixed(1):0,statObj["1st W%"]=x,statObj["2nd W%"]=_,statObj.TPW=f,statObj.RPW=h,statObj["v1st %"]=b,statObj["v2nd %"]=C,statObj["vA %"]=+s[1]?(+o[1]/+s[1]*100).toFixed(1):0,statObj.BP=+p[1],statObj["BP Cnv"]=+p[1]-+u[1],statObj["BPC %"]=y,statObj["BP Svd"]=+u[0],statObj["BP Fcd"]=+p[0],statObj["BPS %"]=g,statObj.Time=n.match.duration?(n.match.duration/60).toFixed(2):0,a.push(statObj)}}),a}function S(e,t){function a(e){return[e[1],e[0],e[3]||"",e[2]||""]}function n(e){e.overview.calcs.forEach(function(e){var t=Object.keys(e);t.forEach(function(t){Array.isArray(e[t])&&e[t].length&&e[t].reverse()})}),e.raw.forEach(function(e){var t=Object.keys(e);t.forEach(function(t){Array.isArray(e[t])&&e[t].reverse()})})}t.forEach(function(t){var r=t.metadata.players.map(function(e){return e.name});1==r.indexOf(e)&&(t.metadata.players=a(t.metadata.players),t.stats.forEach(function(e){n(e)}))})}function j(e,t){if(t=t||this,13==e.which||9==e.which){var a=(t.parentElement.parentElement.getAttribute("fx"),t.parentElement.querySelector("li"));if(a)l(a.textContent);else if(!t.value){var n=t.getAttribute("placeholder");n.indexOf("Opponent")<0&&l(n)}}}function D(e,t){if(t=t||this,13==e.which||9==e.which){var a=t.parentElement.querySelector("li");if(a)d(a.textContent);else if(!t.value){var n=t.getAttribute("placeholder");n.indexOf("Tournament")<0&&d(n)}}}function A(e){return e=e.toLowerCase(),e.indexOf("grass")>=0?"grass":e.indexOf("hard")>=0?"hard":e.indexOf("acrylic")>=0?"hard":e.indexOf("clay")>=0?"clay":e.indexOf("carpet")>=0?"carpet":"unknown"}function R(e){U.show("pc_div");var t=[];return e?(e.matches.forEach(function(e,a){t.push(L(e.data,a)),e.umo=e.data.umo}),q.pHorizonGroup.data(t),void q.pHorizonGroup.update()):void q.pHorizonGroup.data([])}function L(e,t){if(void 0==e.umo){var a=mo.matchObject();a.options(e.opts),a.metadata(e.metadata),I(e,a),e.umo=a}var n=ptsHorizon().data(e.umo).colors([ae.colors.players[0],ae.colors.players[1]]).events({chart:{click:H}});return n.options({id:"hc"+t,height:50,display:{sizeToFit:!0},elements:{brush:!1}}),n.events({mouseover:null,mouseout:null}),e.outcome=G(e.score,e.metadata.players,e.metadata.tournament.round),{score:e.outcome,umo:e.umo,won:e.won,horizon:n}}function B(e,t,a){var n=ae.elements,r=Object.keys(n);t&&t.length&&(r=r.filter(function(e){return t.indexOf(e)<0})),a&&a.length&&(r=r.filter(function(e){return a.indexOf(e)>=0})),r.forEach(function(t){var a=document.getElementById(n[t]);a&&(a.style.display=e)})}function T(e,t){if(e&&t)for(var a=Object.keys(e),n=Object.keys(t),r=0;r<a.length;r++)if(n.indexOf(a[r])>=0){var o=t[a[r]],i=e[a[r]];"object"==typeof o&&"function"!=typeof i&&o.constructor!==Array?T(e[a[r]],t[a[r]]):t[a[r]]=e[a[r]]}}function M(e){function t(e,t){if(e){e=o(e);var n=e[0].data.metadata,i=n.match.year,s=n.tournament.name,c=A(r(e,"surface"));return{tournament:s,tidx:t,tuid:n.tournament.tuid,tour:n.tournament.tour,year:i,date:new Date(n.match.date),surface:c?c.toLowerCase():"",matches:e,sources:a(e)}}}function a(e){var t=[];return e.forEach(function(e){e.data.sources.forEach(function(e){!t.indexOf(e)>=0&&t.push(e)})}),t}function n(e){if(!e.length)return[];var t=0,a=[],n=[],r=e[0].tuid,o=new Date(e[0].data.metadata.match.date);return e.forEach(function(e){var i=new Date(e.data.metadata.match.date);e.data.metadata.tournament.name.indexOf("Fed Cup")<0&&e.data.metadata.tournament.name.indexOf("Davis Cup")<0&&(e.tuid==r&&W(i,o)<20?(e.data.tidx=t,n.push(e)):(a.push(n),t+=1,e.data.tidx=t,n=[e],o=i,r=e.tuid))}),n.length&&a.push(n),a=a.filter(function(e){return e.map(function(e){return e.round}).join("").length})}function r(e,t){for(var a=0;a<e.length;a++){var n=e[a].data.metadata.tournament[t];if(n)return n}return""}function o(e){var t={F:1,SF:2,QF:3,R16:4,R32:5,R64:6,R128:7,Q:8,RR:4,Q3:8,Q2:9,Q1:10},a=e.filter(function(e){return Object.keys(t).indexOf(e.round)>=0}),n=e.filter(function(e){return Object.keys(t).indexOf(e.round)<0});return n.sort(function(e,t){return t.won&!e.won?0:1}),a.sort(function(e,a){return t[e.round]<t[a.round]?0:1}),a.concat(n)}var i=n(e),s=i.map(function(e,a){return t(e,a)});return s}function I(e,t){if(e.codes&&e.codes.length){t.options(e.options),t.metadata(e.metadata),e.codes.length>1&&e.codes.sort(function(e,t){return e.source<t.source?0:1});var a=e.codes[0].first_service;a!=t.options().match.first_service&&t.options({match:{first_service:a}}),e.codes[0].code.forEach(function(e){t.push(sequences.pointParser(e.split("|")))})}}function H(e){var t=document.getElementById("tournamentEnd");if(window.scrollTo(0,t.offsetTop),e.umo||e.data.codes.length){ne.updateMatch(e.umo);var a=e.umo.metadata(),n=["Player Match:",a.tournament.name,a.match.date,e.umo.teams().join("-")].join(" ").replace(/\ /g,"_");aip&&aip.sendReport(n);var r=new Date(e.umo.metadata().match.date);d3.select("#matchDate").text(r.toDateString())}else ee("clear")}function W(e,t){return Math.round(Math.abs(+e-+t)/864e5)}function G(e,t,a){score_string="";for(var n=0;n<e.length;n++)score_string&&(score_string+=", "),score_string+=e[n].player0+"-"+e[n].player1,void 0!=e[n].tiebreak&&(score_string+="("+e[n].tiebreak+")");var r=t[1].name.split(" ");return score_string=a+": "+r[r.length-1]+" "+score_string,score_string}function Q(e){9==e.which&&e.preventDefault()}var N,U={player:{name:void 0,puid:void 0},codesFetched:!1},V={},q={},K=[],Y=[],J=[],X=[],Z=[],$=[],ee="inline",te=!1,ae={elements:{season_div:void 0,dp_div:void 0,pc_div:void 0,mr_div:void 0,horizon_group:void 0,t_overview:void 0,t_end:void 0},colors:{players:{0:"",1:""},surfaces:{hard:"#235dba",clay:"#db3e3e",grass:"#66CD00",carpet:"#33cccc",unknown:"#a7a59b"},filters:{}}},ne={clickTournament:null,updateMatch:null},re=["Q","R128","R64","R32","R16","QF","SF","F","W"],oe={F:600,C:500,A:400,D:900,M:1200,G:2e3,W:1500,PM:1e3,P:800,I:600};return U.init=function(){ae.elements.pc_div&&(q.pCoords=pCoords().colors(ae.colors.surfaces).options({plot:{lines:{colorKey:"surface"}},display:{settingsImg:"/images/gear.png",helpImg:"/images/help.png"}}).events({lines:{click:e,mouseover:t,mouseout:n},axis:{y:{click:r}},brush:{brushed:u,start:m,end:f,clear:p},settings:{click:v},help:{click:h}}).hide(["muid","surface","Date","vRank","aRank","vAge","aAge","Time","vA %","v1st %","v2nd %","BP","BP Cnv","BPC %","BP Svd","BP Fcd","BPS %"]).scales({Won:{scale:d3.scale.linear(),domain:[0,1]}}),d3.select("#"+ae.elements.pc_div).call(q.pCoords)),ae.elements.season_div&&(q.ladderChart=ladderChart().colors(ae.colors.surfaces).options({data:{contextAttribute:"tidx",fullYearsOnly:!0,oneYearMinimum:!0},display:{source:""},plot:{source:{text:""},shape:{dateKey:"date",rungKey:"rung",colorKey:"surface",sizeKey:"rank",shapeSizeBase:22e3,typeKey:"category",typeRange:["circle","circle","triangle","triangle","square"],typeDomain:["atp","wta","itf","ch","fu"]},content:{rows:re}},display:{settingsImg:"/images/gear.png",helpImg:"/images/help.png"}}),q.ladderChart.events({settings:{click:h},help:{click:h},item:{mouseover:k,mouseout:E,click:P},axis:{x:{click:x},y:{click:b}},title:{click:C}}),d3.select("#"+ae.elements.season_div).call(q.ladderChart)),ae.elements.dp_div&&(q.datePicker=datePicker(),q.datePicker.events({brush:{end:function(e){_(e.range)}}}),d3.select("#"+ae.elements.dp_div).call(q.datePicker)),ae.elements.mr_div&&(q.matchRadar=RadarChart().options({legend:{display:!0},resize:!0,margins:{top:100,right:60,bottom:80,left:80},axes:{threshold:90}}),q.matchRadar.levels(6).duration(0).update(),d3.select("#"+ae.elements.mr_div).call(q.matchRadar)),ae.elements.horizon_group&&(q.pHorizonGroup=ptsHorizonGroup(),d3.select("#"+ae.elements.horizon_group).call(q.pHorizonGroup))},U.displayMCPmatches=function(){$=$.filter(function(e){return e.sources.indexOf("mcp")>=0}),Z=$,J=J.filter(function(e){return e.data.sources.indexOf("mcp")>=0}),X=J,U.displayLadder($)},U.displayPBPmatches=function(){$=$.filter(function(e){return e.sources.indexOf("pbp")>=0}),Z=$,J=J.filter(function(e){return e.data.sources.indexOf("pbp")>=0}),X=J,U.displayLadder($)},U.clearFilteredMatches=p,U.selectAxes=function(){var e=[],t=document.querySelectorAll(".settingsPC");for(a=0;a<t.length;a++)t[a].checked&&e.push(t[a].value);var n=q.pCoords.hide(),r=q.pCoords.activeAxes().concat(n),o=r.filter(function(t){return e.indexOf(t)<0});q.pCoords.clearBrushes(),q.pCoords.activeAxes(e),q.pCoords.hide(o).update(),interact.closeModal()},U.surfaceCount=g,U.matchSurfaces=y,U.clear=function(){U.hide(["pc_div"]),U.player.name="",U.player.puid="",U.codesFetched=!1,U.clearFilteredMatches(),K=[],$=[],display_tournaments=$,J=[],X=J,q.datePicker.data([void 0,void 0]).update(),U.displayLadder($)},U.filterSurface=w,U.zoomByRange=_,U.hide=function(e){B("none",void 0,e),ee="none"},U.show=function(e){B("inline",e),ee="inline"},U.displayState=function(){return display_state},U.tournaments=function(e){if(te=!1,!arguments.length)return Y;K=e,V={},K.forEach(function(e,t){V[e.muid]=t}),Y=M(e);var t=Y.map(function(e){return e.date});U.maxDate=new Date(Math.max.apply(null,t)),$=Y,Z=Y,J=K,X=K},U.addStats=function(e,t){S(e,t),F(t),U.displayStats(K)},U.displayStats=function(e){e=e||K;var t=z(e);t.length?(U.show(),U.charts().pCoords.data(t).update()):U.hide("pc_div")},U.displayLadder=function(e){e=e||Y,U.displayStats(J);var t=U.surfaceCount($);U.displayCounts(t,"#surfaceFilters"),U.df(),U.hide(["horizon_group"]),d3.select("#tName").text(""),d3.select("#matchDate").text(""),mv.hide(),N=void 0;var a={values:[]};e.forEach(function(e){var t=e.matches[0],n=t.data.metadata.tournament.round;if("RR"==n)var r=4;else var r=re.indexOf(n);r==re.length-2&&t.won&&(r=re.length-1);var o=t.data.metadata.tournament.rank,i=o?oe[o]:280;i=i||400;var s={tournament:e.tournament,codesFetched:U.codesFetched,tuid:e.tuid,tidx:e.tidx,round:n,category:e.tour||"atp",surface:A(e.surface.toLowerCase()),rank:i,rung:r>0?r:0,date:new Date(t.data.metadata.match.date),matches:e.matches};a.values.push(s)}),q.ladderChart.options({plot:{title:{text:U.player.name}}}),U.charts().ladderChart.data(a).update()},U.df=function(){var e=[],t=o(J);t&&e.push({append:"text",style:{cursor:"pointer"},attr:{transform:"translate(25, 15)"},text:"MCP: "+t,click:U.displayMCPmatches});var a=i(J);a&&e.push({append:"text",style:{cursor:"pointer"},attr:{transform:"translate(25, 15)"},text:"PBP: "+a,click:U.displayPBPmatches});var n=s(J);if(n){var r=1==n.length?n[0]:"Opponents: "+n.length;e.push({fx:"displayOpponentMatches",attr:{id:"selectedOpponents","class":"filter-input filter-opponent",type:"text",placeholder:r},type:"input"})}var u=c($);if(u){var r=1==u.length?u[0]:"Tournaments: "+u.length;e.push({fx:"displayTournamentMatches",attr:{id:"selectedTournaments","class":"filter-input filter-tournament",type:"text",placeholder:r},type:"input"})}U.displayFilters(e);var p=document.getElementById("selectedOpponents");p&&(new Awesomplete(p,{list:n}),p.onfocus=function(){this.setSelectionRange(0,this.value.length)},p.addEventListener("keydown",Q,!1),p.addEventListener("keyup",j,!1),p.addEventListener("awesomplete-selectcomplete",function(){l(this.value)},!1));var m=document.getElementById("selectedTournaments");m&&(new Awesomplete(m,{list:u}),m.onfocus=function(){this.setSelectionRange(0,this.value.length)},m.addEventListener("keydown",Q,!1),m.addEventListener("keyup",D,!1),m.addEventListener("awesomplete-selectcomplete",function(){d(this.value)},!1))},U.displayFilters=function(e){var t=d3.select("#otherFilters");t.selectAll(".filter").remove(),e.forEach(function(e,a){function n(){e.click&&e.click()}var r=t.append("div").attr({"class":"flex-filters filter",id:"filter"+a,fx:e.fx}).style({height:"20px",cursor:"pointer"}).on("click",function(){n(this)});if("input"==e.type)r.append("input").attr(e.attr);else{var o=r.append("svg").attr({"class":"sSvg",height:"20px",width:"200px"});o.append("text").style(e.style).attr(e.attr).text(e.text)}})},U.displayCounts=function(e,t,a){a=void 0==a?!0:a;var n=Object.keys(e).sort(),r={tournaments:0,matches:0,wins:0};n.forEach(function(t){e[t].tournaments&&(r.tournaments+=e[t].tournaments),e[t].matches&&(r.matches+=e[t].matches),e[t].wins&&(r.wins+=e[t].wins)}),e.all=r,n.unshift("all");var o=d3.select(t);o.selectAll(".sc").remove(),n.forEach(function(t,n){function r(e){if(a)if("all"==t)C();else{var n=d3.select(e);U.filterSurface(n.attr("surface"))}}var i=e[t].wins+"/"+e[t].matches,s=e[t].matches?(e[t].wins/e[t].matches*100).toFixed(1)+"%":"",c=o.append("div").attr({"class":"flex-filters sc",id:"surface"+n,surface:t}).style({cursor:function(){return a?"pointer":"default"}}).on("click",function(){r(this)}),l=t[0].toUpperCase()+t.substring(1),d=c.append("svg").attr({"class":"sSvg",height:"20px",width:"200px",surface:t});d.append("circle").style({cursor:function(){return a?"pointer":"default"},stroke:ae.colors.surfaces[t],"stroke-width":1}).attr({transform:"translate(10, 10)",fill:ae.colors.surfaces[t],r:6}).on("click",function(){r(this)}),d.append("text").style({cursor:function(){return a?"pointer":"default"}}).attr({transform:"translate(25, 15)"}).text(function(){var e=l+": "+i;return s&&(e=e+" ("+s+")"),e})})},U.updateCharts=R,U.resize=function(){if("none"!=ee){if(ae.elements.mr_div&&q.matchRadar){var e=d3.select("#"+ae.elements.mr_div),t=e.node().getBoundingClientRect().width,a=e.node().getBoundingClientRect().height,n=Math.min(t,a);q.matchRadar.width(n).height(n).update()}ae.elements.horizon_group&&q.pHorizonGroup&&q.pHorizonGroup.update(),ae.elements.season_div&&q.ladderChart&&q.ladderChart.update({sizeToFit:!0}),ae.elements.pc_div&&q.pCoords.update(),ae.elements.dp_div&&q.datePicker.update()}},U.charts=function(){return q},U.options=function(e){return arguments.length?(T(e,ae),U):ae},U.events=function(e){return arguments.length?(T(e,ne),U):ne},U}function matchView(){function e(){function e(){var e=rallyChart.displayPct();rallyChart.displayPct(!e)}function t(){var e=d.mc.options().display.orientation;d.mc.options("vertical"==e?{display:{orientation:"horizontal"}}:{display:{orientation:"vertical"}}),d.mc.update()}if(p.elements.matchOverview&&(d.ov=mOverview(),d.ov.options({colors:p.colors}),d3.select("#"+p.elements.matchOverview).call(d.ov)),p.elements.statPanel&&(d.sv=statView(),d.sv.options({colors:p.colors}),d3.select("#"+p.elements.statPanel).call(d.sv)),p.elements.horizon_div&&(d.pHorizon=ptsHorizon(),d3.select("#"+p.elements.horizon_div).call(d.pHorizon),d.pHorizon.width(600).height(70),d.pHorizon.colors([p.colors.players[0],p.colors.players[1]])),p.elements.rt_div&&(d.rallyChart=rallyTree().width(150).height(150),d.rallyChart.events({statbar:{click:e}}),d.rallyChart.options({data:{sort:!0},points:{colors:{Ace:"green","Serve Winner":"lightgreen",Winner:"seagreen","Forced Volley Error":"red","Forced Error":"orange","Forcing Error":"green","Passing Shot":"green",In:"yellow","Net Cord":"yellow","Double Fault":"red","Unforced Error":"red",Out:"coral",Netted:"red",Net:"red","Out Long":"red","Out Passing Shot":"red",OO:"red"}}}),d3.select("#"+p.elements.rt_div).call(d.rallyChart)),p.elements.gt_div){d.gameTree=GameTree();var a={lines:{points:{winners:"green",errors:"#BA1212",unknown:"#2ed2db"},colors:{underlines:"black"}},nodes:{colors:{0:p.colors.players[0],1:p.colors.players[1],neutral:"#ecf0f1"}},points:{winners:["Winner","Ace","Serve Winner","Passing Shot","Return Winner","Forcing Error","Net Cord","In"],errors:["Unforced Error","Unforced","Forced","Error","Forced Error","Out","Net","Netted Passing Shot","Long","Out Passing Shot"]}};d.gameTree.options(a),d.gameTree.width(150).height(150).update(),d3.select("#"+p.elements.gt_div).call(d.gameTree)}if(p.elements.pts_div){d.pts_match=ptsMatch();var n={resize:!1,colors:p.colors};d.pts_match.options(n),d.pts_match.duration(1e3),d.pts_match.width(500).height(70),d3.select("#"+p.elements.pts_div).call(d.pts_match)}p.elements.gf_chart&&(d.gamefish=gameFish(),d.gamefish.options({colors:p.colors}),d3.select("#"+p.elements.gf_chart).call(d.gamefish)),p.elements.pts_div&&(d.mc=momentumChart(),d.mc.options({display:{continuous:!1,settingsImg:"/images/gear2.png",orientation:"horizontal",transition_time:1e3,service:!1,rally:!0,player:!1,grid:!1},colors:p.colors}),d3.select("#"+p.elements.m_chart).call(d.mc),d.mc.events({settings:{click:t}}))}function t(){function e(e,a,n){t(e,a,n);var r=d.gameTree.options().selectors.selected,o=r[0]?0:r[1]?1:void 0;d.rallyChart.pointsServed(o)}var t=d.gameTree.exports().selectView;d.gameTree.events({label:{click:e},selector:{click:e}}),d.pts_match.events({point_bars:{click:r}}),d.pHorizon.events({brush:{end:n}})}function a(){if("inline"!=u)return void console.log("Cannot update charts when not displayed");d.ov.data(c),d.ov.update(),d.sv.data(statistics.statObjects(c.points())),d.sv.update(),d.pHorizon.data(c);var e=d3.max(c.points().map(function(e){return e.rally?e.rally.length:0}));e?(d.rallyChart.options({data:{sort:!0}}),d.rallyChart.points(c.points())):d3.select("#rallytree").style("display","none");var t=Math.max.apply(null,c.sets().map(function(e){return e.points().length})),a={set:{average_points:t},points:{max_width_points:t}};d.pts_match.options(a),d.pts_match.data(c),d.mc.data(c);var n=c.teams();d.gameTree.options({labels:{Player:n[0],Opponent:n[1]}}),d.gameTree.data(c.points()),d.gameTree.update(),l.resize()}function n(e){var t=Math.floor(e[0]),a=Math.ceil(e[1]),n=c.sets().map(function(e){return e.points().length}).reverse();n.forEach(function(e){a>=e&&(a-=1),t>=e&&(t-=1)});var r=c.points(),o=r.slice(Math.floor(e[0]),Math.ceil(e[1]));o.length>1?(d.sv.data(statistics.statObjects(o)).update(),d.rallyChart.points(o).update(),d.gameTree.data(o).update()):(d.sv.data(statistics.statObjects(r)).update(),d.rallyChart.points(r).update(),d.gameTree.data(r).update())}function r(e){function t(e,t,a){gamescore=c.sets()[e].games()[t].score,gamerange=c.sets()[e].games()[t].range,gamepoints=c.sets()[e].points().slice(gamerange[0],gamerange[1]+1),a.options({score:gamescore}),a.data(gamepoints)}var a=o();d.gamefish.height(a).update(),t(e.set,e.game,l.charts().gamefish),d.gamefish.update({sizeToFit:!0})}function o(){return parseInt(d3.select(".ptsMatchroot").style("height").replace(/[^\d\.]*/g,""))}function i(e){Object.keys(p.elements).forEach(function(t){var a=document.getElementById(p.elements[t]);a&&(a.style.display=e)})}function s(e,t){if(e&&t)for(var a=Object.keys(e),n=Object.keys(t),r=0;r<a.length;r++)if(n.indexOf(a[r])>=0){var o=t[a[r]],i=e[a[r]];"object"==typeof o&&"function"!=typeof i&&o.constructor!==Array?s(e[a[r]],t[a[r]]):t[a[r]]=e[a[r]]}}var c,l={},d={},u="none",p={elements:{tournament:void 0,matchOverview:void 0,geoLocation:void 0,statPanel:void 0,rt_div:void 0,gt_div:void 0,horizon_div:void 0,pts_div:void 0,m_chart:void 0,gf_chart:void 0},colors:{players:{0:"",1:""}}},m={};return l.init=function(){e(),t()},l.hide=function(){i("none"),u="none"},l.show=function(){i("inline"),u="inline"},l.displayState=function(){return display_state},l.umo=function(e){return arguments.length?void("function"==typeof e&&"UMO"==e.type&&(c=e,a())):c},l.options=function(e){return arguments.length?(s(e,p),l):p},l.events=function(e){return arguments.length?(s(e,m),l):m},l.charts=function(){return d},l.resize=function(){if("none"!=u){if(p.elements.matchOverview&&d.ov&&d.ov.update(),p.elements.statPanel&&d.sv&&d.sv.update(),p.elements.pts_div&&d.pts_match){var e=d3.select("#"+p.elements.pts_div),t=e.node().getBoundingClientRect().width;d.pts_match.width(t).update()}if(p.elements.gt_div&&d.gameTree){var a=d3.select("#"+p.elements.gt_div),t=a.node().getBoundingClientRect().width,n=.9*t;d.gameTree.width(t).height(n).update()}if(p.elements.rt_div&&d.rallyChart){var o=d3.select("#"+p.elements.rt_div),t=o.node().getBoundingClientRect().width,n=.9*t;d.rallyChart.width(t).height(n).update()}if(p.elements.horizon_div&&d.pHorizon){var i=d3.select("#"+p.elements.horizon_div),t=i.node().getBoundingClientRect().width,s=d.pHorizon.options().display.orientation;"horizontal"==s&&d.pHorizon.width(t).update()}if(p.elements.m_chart&&d.mc){var l=d3.select("#"+p.elements.m_chart),t=l.node().getBoundingClientRect().width;d.mc.options({display:{orientation:600>t?"vertical":"horizontal"}}),d.mc.width(t).update()}p.elements.gf_chart&&d.gamefish&&c&&(d.gamefish.update({sizeToFit:!0}),r(c.points()[0]))}},l}!function(){function e(){var e=document.querySelector("#"+l.domElement+" li");e&&(o.value=e.textContent.split("[")[0].trim()),t()}function t(){document.getElementById("blur").focus(),"function"==typeof d.submit&&d.submit(o.value),a()}function a(e){if(i){var t=i.style.visibility||"hidden";"close"==e?i.style.visibility="hidden":"open"==e?(i.style.visibility="visible",o&&o.focus()):(interact.toggleMenu("close"),"hidden"==t?(i.style.visibility="visible",o&&o.focus()):i.style.visibility="hidden")}}function n(e,t){if(e&&t)for(var a=Object.keys(e),r=Object.keys(t),o=0;o<a.length;o++)if(r.indexOf(a[o])>=0){var i=t[a[o]],s=e[a[o]];"object"==typeof i&&"function"!=typeof s&&i.constructor!==Array?n(e[a[o]],t[a[o]]):t[a[o]]=e[a[o]]}}function r(e){9==e.which&&e.preventDefault()}var o,i,s={},c=!1,l={domElement:void 0,searchForm:void 0,searchIcon:void 0},d={submit:void 0};s.init=function(){if(!l.domElement||!l.searchForm)return c=!1,!1;if(i=document.getElementById(l.domElement),o=document.getElementById(l.searchForm),!i||!o)return c=!1,!1;if(l.searchIcon){var n=document.getElementById(l.searchIcon);n&&(n.onclick=function(){a()})}var s=document.createElement("input");o.appendChild(s),s.setAttribute("id","blur"),s.setAttribute("type","text"),s.style.position="absolute",s.style.opacity="0",o.addEventListener("keydown",r,!1),o.addEventListener("keyup",function(t){(13==t.which||9==t.which)&&e()}),o.addEventListener("awesomplete-selectcomplete",function(){t()},!1)},s.toggleSearch=a,s.options=function(e){return arguments.length?(n(e,l),s):l},s.events=function(e){return arguments.length?(n(e,d),s):d},this.search=s}(),!function(){function e(){interact.toggleMenu("close"),mv.hide()}function t(e){o("match"),s("clear");var t="Player Match: "+e.teams().join(" - ");aip&&aip.sendReport(t),a(e)}function a(e){interact.toggleMenu("close"),o("match"),mv.umo(e)}function n(){var e=aip.okeys;if(e.length)if(e.indexOf("player")>=0){if(p.name=decodeURIComponent(aip.QueryString.player).split("+").join(" "),!p.name.length)return;p.name=p.name.toLowerCase(),p.name=p.name.split(" ").filter(function(e){return e}).map(function(e){return e[0].toUpperCase()+e.slice(1)}).join(" "),thePlayer.value=p.name,c(thePlayer.value)}else{var a=parsers.loaders.filter(function(t){return e.indexOf(t.toLowerCase())>-1&&"text"==parsers[t.toUpperCase()].file_format});a.length>0&&d3.text("/cache/mailcache/"+a[0].toLowerCase()+"/"+aip.QueryString[a[0].toLowerCase()],function(e,n){!e&&n&&(parsers.umo=mo.matchObject(),parsers[a[0]].parse(n),pv.hide(),t(parsers.umo))})}}function r(e){if(e.length){o("match"),d3.select("#radar").style("display","none"),window.scrollTo(0,0),s("results"),mv.hide(),pv.show(["pc_div"]),history.pushState({foo:""},"","?player="+thePlayer.value),pv.player.name=thePlayer.value,pv.player.puid=p.puid,pv.codesFetched=m,pv.tournaments(e);var t=[e.length?new Date(e[0].data.metadata.match.date):void 0,e.length?new Date(e[e.length-1].data.metadata.match.date):void 0];pv.charts().datePicker.data(t).update(),pv.charts().ladderChart.options({plot:{title:{text:pv.player.name}}}),pv.displayLadder(),pv.updateCharts(),pv.resize()}}function o(e){"match"==e?(d3.select("#matchesDisplay").style("display","inline"),d3.select("#splashSection").style("display","none"),mv.show()):(pv.clear(),mv.hide())}function i(){mv.resize(),pv.resize()}function s(e){"results"==e?(d3.select("#prompt").style("display","none"),d3.select("#resultMenu").style("display","inline")):(d3.select("#prompt").style("display","inline"),d3.select("#resultMenu").style("display","none"))}function c(e){function t(){pv.clear();var t=document.getElementById("seasonChart"),a=new Spinner(h).spin(t),n=new Date;aip.findPlayerCodes(e,"",function(t,i){function c(){search.toggleSearch("close"),o("clear"),s("clear")}if(a.stop(),!t){console.log("Fetch Time:",new Date-n),m=!1,i=i.filter(function(e){return e.metadata.tournament.name.indexOf("Fed Cup")<0&&e.metadata.tournament.name.indexOf("Davis Cup")<0}),i.length<0&&c(),d3.select("#prompt").style("display","none");var u=("Player Search: "+e).replace(/\ /g,"_");aip&&aip.sendReport(u),l(e);var p=d(i,e);r(p)}})}return console.log(e),e?(o("match"),void aip.playerBio(e,function(e,a){!e&&a.length?(p.puid=a[0].puid,t()):(o("clear"),s("clear"),d3.select("#matchesDisplay").style("display","none"),d3.select("#splashSection").style("display","inline"))})):(o("clear"),void s("clear"))}function l(e){aip.getPlayerStats(e,function(t,a){pv.addStats(e,a)})}function d(e,t){var a=[];e.sort(function(e,t){var a=new Date(e.metadata.match.date),n=new Date(t.metadata.match.date);return n-a});for(var n=0;n<e.length;n++){var r=e[n],o=r.metadata.players[0].name!=t?!0:!1;if(o){r.opts.match.first_service=1-r.opts.match.first_service;var i=r.metadata.players,s=i[0];i[0]=i[1],i[1]=s;

var s=i[2];i[2]=i[3],i[3]=s;for(var c=0;c<r.score.length;c++){var s=r.score[c].player0;r.score[c].player0=r.score[c].player1,r.score[c].player1=s}r.codes&&r.codes.length&&r.codes.forEach(function(e){e.first_service=1-e.first_service})}if(r.score.length){r.won=u(r.score).player0>u(r.score).player1,["retired","default","walkover"].indexOf(r.metadata.match.status)>=0&&(r.won=t==r.metadata.match.winner),r.stats&&r.stats.length&&(r.stats=r.stats[0]);var l=r.metadata.tournament.round;r.reversed=o;var d={reversed:o,muid:r.muid,tournament:r.metadata.tournament.name,tuid:r.metadata.tournament.tuid,round:l,year:r.metadata.match.year,won:r.won,first_service:r.opts.match.first_service,data:r,umo:void 0};a.push(d)}}return a}function u(e){return e[e.length-1]}var p={name:"",puid:""},m=!1,f={players:{0:"#6b6ecf",1:"#a55194"}},h={lines:9,length:9,width:5,radius:14,color:["red","blue","green"],speed:1.9,trail:40,className:"spinner",top:"30%"};search.options({domElement:"searchbox",searchForm:"thePlayer",searchIcon:"searchIcon"}).events({submit:c}).init(),mv=matchView(),mv.options({elements:{tournament:"tournament",matchOverview:"matchOverview",geoLocation:"geoLocation",statPanel:"statPanel",rt_div:"rallytree",gt_div:"gametree",horizon_div:"ptsHorizon",pts_div:"pts",m_chart:"momentum",gf_chart:"gamefish"},colors:f}).init(),pv=playerView(),pv.options({elements:{season_div:"seasonChart",dp_div:"datePicker",pc_div:"pCoords",mr_div:"matchRadar",horizon_group:"tournamentHorizons",t_overview:"tournamentOverview",t_end:"tournamentEnd"},colors:f}).events({clickTournament:e,updateMatch:a}).init(),n(),sources&&(sources.umo=mo.matchObject(),sources.uponCompletion=function(){pv.hide(),t(sources.umo)}),readWrite&&(readWrite.uponCompletion=function(){pv.hide(),t(readWrite.umo)}),window.addEventListener("resize",i,!1)}();